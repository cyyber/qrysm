package interop

import (
	"fmt"
	"math"
	"math/big"

	"github.com/theQRL/go-zond/common"
	"github.com/theQRL/go-zond/common/hexutil"
	"github.com/theQRL/go-zond/core"
	"github.com/theQRL/go-zond/params"
	clparams "github.com/theQRL/qrysm/v4/config/params"
	"github.com/theQRL/qrysm/v4/time/slots"
)

// defaultMinerAddress is used to send deposits and test transactions in the e2e test.
// This account is given a large initial balance in the genesis block in test setups.
const defaultMinerAddress = "0x878705ba3f8bc32fcf7f4caa1a35e72af65cf766"
const defaultTestChainId int64 = 1337
const defaultCoinbase = "0x0000000000000000000000000000000000000000"
const defaultDifficulty = "0"
const defaultMixhash = "0x0000000000000000000000000000000000000000000000000000000000000000"
const defaultParenthash = "0x0000000000000000000000000000000000000000000000000000000000000000"
const defaultMinerBalance = "100000000000000000000000000000"

// DepositContractCode is the compiled deposit contract code, via https://github.com/protolambda/merge-genesis-tools
// This is embedded into genesis so that we can start the chain at a merge block.
// const DepositContractCode = "0x60806040523480156200001157600080fd5b5060005b600160206200002591906200014d565b8110156200010d5760026021826020811062000046576200004562000188565b5b0154602183602081106200005f576200005e62000188565b5b015460405160200162000074929190620001e6565b6040516020818303038152906040526040516200009291906200028f565b602060405180830381855afa158015620000b0573d6000803e3d6000fd5b5050506040513d601f19601f82011682018060405250810190620000d59190620002de565b6021600183620000e6919062000310565b60208110620000fa57620000f962000188565b5b0181905550808060010191505062000015565b506200034b565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006200015a8262000114565b9150620001678362000114565b92508282039050818111156200018257620001816200011e565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b6000819050919050565b620001e0620001da82620001b7565b620001c1565b82525050565b6000620001f48285620001cb565b602082019150620002068284620001cb565b6020820191508190509392505050565b600081519050919050565b600081905092915050565b60005b838110156200024c5780820151818401526020810190506200022f565b60008484015250505050565b6000620002658262000216565b62000271818562000221565b9350620002838185602086016200022c565b80840191505092915050565b60006200029d828462000258565b915081905092915050565b600080fd5b620002b881620001b7565b8114620002c457600080fd5b50565b600081519050620002d881620002ad565b92915050565b600060208284031215620002f757620002f6620002a8565b5b60006200030784828501620002c7565b91505092915050565b60006200031d8262000114565b91506200032a8362000114565b92508282019050808211156200034557620003446200011e565b5b92915050565b611924806200035b6000396000f3fe60806040526004361061003f5760003560e01c806301ffc9a7146100445780632289511814610081578063621fd1301461009d578063c5f2892f146100c8575b600080fd5b34801561005057600080fd5b5061006b60048036038101906100669190610b96565b6100f3565b6040516100789190610bde565b60405180910390f35b61009b60048036038101906100969190610c94565b6101c5565b005b3480156100a957600080fd5b506100b261060f565b6040516100bf9190610ded565b60405180910390f35b3480156100d457600080fd5b506100dd610621565b6040516100ea9190610e1e565b60405180910390f35b60007f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614806101be57507f85640907000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b9050919050565b610a20878790501461020c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161020390610ebc565b60405180910390fd5b60208585905014610252576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161024990610f4e565b60405180910390fd5b6111f38383905014610299576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161029090610fe0565b60405180910390fd5b670de0b6b3a76400003410156102e4576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102db90611072565b60405180910390fd5b6000633b9aca00346102f691906110cb565b14610336576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161032d9061116e565b60405180910390fd5b6000633b9aca003461034891906111bd565b905067ffffffffffffffff8016811115610397576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161038e90611260565b60405180910390fd5b60006103a2826107fc565b90507f649bbc62d0e31342afea4e5cd82d4049e7e1ee912fc0889aa790803be39038c589898989858a8a6103d76020546107fc565b6040516103eb9897969594939291906112bc565b60405180910390a1600060018a8a8a8a868b8b6040516104119796959493929190611338565b602060405180830381855afa15801561042e573d6000803e3d6000fd5b5050506040513d601f19601f8201168201806040525081019061045191906113b4565b9050838114610495576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161048c90611479565b60405180910390fd5b6001602060026104a591906115cc565b6104af9190611617565b602054106104f2576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104e9906116bd565b60405180910390fd5b60016020600082825461050591906116dd565b925050819055506000602054905060005b60208110156105f15760018083160361054d57826000826020811061053e5761053d611711565b5b01819055505050505050610606565b60026000826020811061056357610562611711565b5b015484604051602001610577929190611761565b60405160208183030381529060405260405161059391906117c9565b602060405180830381855afa1580156105b0573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906105d391906113b4565b92506002826105e291906111bd565b91508080600101915050610516565b506000610601576106006117e0565b5b505050505b50505050505050565b606061061c6020546107fc565b905090565b6000806000602054905060005b6020811015610773576001808316036106ce5760026000826020811061065757610656611711565b5b01548460405160200161066b929190611761565b60405160208183030381529060405260405161068791906117c9565b602060405180830381855afa1580156106a4573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906106c791906113b4565b9250610757565b600283602183602081106106e5576106e4611711565b5b01546040516020016106f8929190611761565b60405160208183030381529060405260405161071491906117c9565b602060405180830381855afa158015610731573d6000803e3d6000fd5b5050506040513d601f19601f8201168201806040525081019061075491906113b4565b92505b60028261076491906111bd565b9150808060010191505061062e565b506002826107826020546107fc565b600060401b6040516020016107999392919061185c565b6040516020818303038152906040526040516107b591906117c9565b602060405180830381855afa1580156107d2573d6000803e3d6000fd5b5050506040513d601f19601f820116820180604052508101906107f591906113b4565b9250505090565b6060600867ffffffffffffffff81111561081957610818611895565b5b6040519080825280601f01601f19166020018201604052801561084b5781602001600182028036833780820191505090505b50905060008260c01b90508060076008811061086a57610869611711565b5b1a60f81b8260008151811061088257610881611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350806006600881106108c5576108c4611711565b5b1a60f81b826001815181106108dd576108dc611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350806005600881106109205761091f611711565b5b1a60f81b8260028151811061093857610937611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a9053508060046008811061097b5761097a611711565b5b1a60f81b8260038151811061099357610992611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a905350806003600881106109d6576109d5611711565b5b1a60f81b826004815181106109ee576109ed611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080600260088110610a3157610a30611711565b5b1a60f81b82600581518110610a4957610a48611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080600160088110610a8c57610a8b611711565b5b1a60f81b82600681518110610aa457610aa3611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535080600060088110610ae757610ae6611711565b5b1a60f81b82600781518110610aff57610afe611711565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916908160001a90535050919050565b600080fd5b600080fd5b60007fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b610b7381610b3e565b8114610b7e57600080fd5b50565b600081359050610b9081610b6a565b92915050565b600060208284031215610bac57610bab610b34565b5b6000610bba84828501610b81565b91505092915050565b60008115159050919050565b610bd881610bc3565b82525050565b6000602082019050610bf36000830184610bcf565b92915050565b600080fd5b600080fd5b600080fd5b60008083601f840112610c1e57610c1d610bf9565b5b8235905067ffffffffffffffff811115610c3b57610c3a610bfe565b5b602083019150836001820283011115610c5757610c56610c03565b5b9250929050565b6000819050919050565b610c7181610c5e565b8114610c7c57600080fd5b50565b600081359050610c8e81610c68565b92915050565b60008060008060008060006080888a031215610cb357610cb2610b34565b5b600088013567ffffffffffffffff811115610cd157610cd0610b39565b5b610cdd8a828b01610c08565b9750975050602088013567ffffffffffffffff811115610d0057610cff610b39565b5b610d0c8a828b01610c08565b9550955050604088013567ffffffffffffffff811115610d2f57610d2e610b39565b5b610d3b8a828b01610c08565b93509350506060610d4e8a828b01610c7f565b91505092959891949750929550565b600081519050919050565b600082825260208201905092915050565b60005b83811015610d97578082015181840152602081019050610d7c565b60008484015250505050565b6000601f19601f8301169050919050565b6000610dbf82610d5d565b610dc98185610d68565b9350610dd9818560208601610d79565b610de281610da3565b840191505092915050565b60006020820190508181036000830152610e078184610db4565b905092915050565b610e1881610c5e565b82525050565b6000602082019050610e336000830184610e0f565b92915050565b600082825260208201905092915050565b7f4465706f736974436f6e74726163743a20696e76616c6964207075626b65792060008201527f6c656e6774680000000000000000000000000000000000000000000000000000602082015250565b6000610ea6602683610e39565b9150610eb182610e4a565b604082019050919050565b60006020820190508181036000830152610ed581610e99565b9050919050565b7f4465706f736974436f6e74726163743a20696e76616c6964207769746864726160008201527f77616c5f63726564656e7469616c73206c656e67746800000000000000000000602082015250565b6000610f38603683610e39565b9150610f4382610edc565b604082019050919050565b60006020820190508181036000830152610f6781610f2b565b9050919050565b7f4465706f736974436f6e74726163743a20696e76616c6964207369676e61747560008201527f7265206c656e6774680000000000000000000000000000000000000000000000602082015250565b6000610fca602983610e39565b9150610fd582610f6e565b604082019050919050565b60006020820190508181036000830152610ff981610fbd565b9050919050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565207460008201527f6f6f206c6f770000000000000000000000000000000000000000000000000000602082015250565b600061105c602683610e39565b915061106782611000565b604082019050919050565b6000602082019050818103600083015261108b8161104f565b9050919050565b6000819050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601260045260246000fd5b60006110d682611092565b91506110e183611092565b9250826110f1576110f061109c565b5b828206905092915050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565206e60008201527f6f74206d756c7469706c65206f66206777656900000000000000000000000000602082015250565b6000611158603383610e39565b9150611163826110fc565b604082019050919050565b600060208201905081810360008301526111878161114b565b9050919050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052601160045260246000fd5b60006111c882611092565b91506111d383611092565b9250826111e3576111e261109c565b5b828204905092915050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565207460008201527f6f6f206869676800000000000000000000000000000000000000000000000000602082015250565b600061124a602783610e39565b9150611255826111ee565b604082019050919050565b600060208201905081810360008301526112798161123d565b9050919050565b82818337600083830152505050565b600061129b8385610d68565b93506112a8838584611280565b6112b183610da3565b840190509392505050565b600060a08201905081810360008301526112d7818a8c61128f565b905081810360208301526112ec81888a61128f565b905081810360408301526113008187610db4565b9050818103606083015261131581858761128f565b905081810360808301526113298184610db4565b90509998505050505050505050565b6000608082019050818103600083015261135381898b61128f565b9050818103602083015261136881878961128f565b9050818103604083015261137c8186610db4565b9050818103606083015261139181848661128f565b905098975050505050505050565b6000815190506113ae81610c68565b92915050565b6000602082840312156113ca576113c9610b34565b5b60006113d88482850161139f565b91505092915050565b7f4465706f736974436f6e74726163743a207265636f6e7374727563746564204460008201527f65706f7369744461746120646f6573206e6f74206d6174636820737570706c6960208201527f6564206465706f7369745f646174615f726f6f74000000000000000000000000604082015250565b6000611463605483610e39565b915061146e826113e1565b606082019050919050565b6000602082019050818103600083015261149281611456565b9050919050565b60008160011c9050919050565b6000808291508390505b60018511156114f0578086048111156114cc576114cb61118e565b5b60018516156114db5780820291505b80810290506114e985611499565b94506114b0565b94509492505050565b60008261150957600190506115c5565b8161151757600090506115c5565b816001811461152d576002811461153757611566565b60019150506115c5565b60ff8411156115495761154861118e565b5b8360020a9150848211156115605761155f61118e565b5b506115c5565b5060208310610133831016604e8410600b841016171561159b5782820a9050838111156115965761159561118e565b5b6115c5565b6115a884848460016114a6565b925090508184048111156115bf576115be61118e565b5b81810290505b9392505050565b60006115d782611092565b91506115e283611092565b925061160f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff84846114f9565b905092915050565b600061162282611092565b915061162d83611092565b92508282039050818111156116455761164461118e565b5b92915050565b7f4465706f736974436f6e74726163743a206d65726b6c6520747265652066756c60008201527f6c00000000000000000000000000000000000000000000000000000000000000602082015250565b60006116a7602183610e39565b91506116b28261164b565b604082019050919050565b600060208201905081810360008301526116d68161169a565b9050919050565b60006116e882611092565b91506116f383611092565b925082820190508082111561170b5761170a61118e565b5b92915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052603260045260246000fd5b6000819050919050565b61175b61175682610c5e565b611740565b82525050565b600061176d828561174a565b60208201915061177d828461174a565b6020820191508190509392505050565b600081905092915050565b60006117a382610d5d565b6117ad818561178d565b93506117bd818560208601610d79565b80840191505092915050565b60006117d58284611798565b915081905092915050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052600160045260246000fd5b60007fffffffffffffffffffffffffffffffffffffffffffffffff000000000000000082169050919050565b6000819050919050565b6118566118518261180f565b61183b565b82525050565b6000611868828661174a565b6020820191506118788285611798565b91506118848284611845565b601882019150819050949350505050565b7f4e487b7100000000000000000000000000000000000000000000000000000000600052604160045260246000fdfea26469706673582212204870ee7b3a7bf11fe50491deb227d84308f62e8138a1c9b0369b9d35a8e11c2964736f6c63782c302e382e32332d646576656c6f702e323032332e31312e362b636f6d6d69742e34636639383934362e6d6f64005d"
const DepositContractCode = "0x60806040526004361061003e575f3560e01c806301ffc9a714610042578063228951181461007e578063621fd1301461009a578063c5f2892f146100c4575b5f80fd5b34801561004d575f80fd5b5061006860048036038101906100639190610b67565b6100ee565b6040516100759190610bac565b60405180910390f35b61009860048036038101906100939190610c59565b6101bf565b005b3480156100a5575f80fd5b506100ae6105fb565b6040516100bb9190610da7565b60405180910390f35b3480156100cf575f80fd5b506100d861060d565b6040516100e59190610dd6565b60405180910390f35b5f7f01ffc9a7000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff191614806101b857507f85640907000000000000000000000000000000000000000000000000000000007bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916827bffffffffffffffffffffffffffffffffffffffffffffffffffffffff1916145b9050919050565b610a208787905014610206576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016101fd90610e6f565b60405180910390fd5b6020858590501461024c576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161024390610efd565b60405180910390fd5b6111f38383905014610293576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161028a90610f8b565b60405180910390fd5b670de0b6b3a76400003410156102de576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016102d590611019565b60405180910390fd5b5f633b9aca00346102ef919061106d565b1461032f576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016103269061110d565b60405180910390fd5b5f633b9aca00346103409190611158565b905067ffffffffffffffff801681111561038f576040517f08c379a0000000000000000000000000000000000000000000000000000000008152600401610386906111f8565b60405180910390fd5b5f610399826107dd565b90507f649bbc62d0e31342afea4e5cd82d4049e7e1ee912fc0889aa790803be39038c589898989858a8a6103ce6020546107dd565b6040516103e2989796959493929190611250565b60405180910390a15f60018a8a8a8a868b8b60405161040797969594939291906112ca565b602060405180830381855afa158015610422573d5f803e3d5ffd5b5050506040513d601f19601f820116820180604052508101906104459190611343565b9050838114610489576040517f08c379a000000000000000000000000000000000000000000000000000000000815260040161048090611404565b60405180910390fd5b6001602060026104999190611551565b6104a3919061159b565b602054106104e6576040517f08c379a00000000000000000000000000000000000000000000000000000000081526004016104dd9061163e565b60405180910390fd5b600160205f8282546104f8919061165c565b925050819055505f60205490505f5b60208110156105de5760018083160361053d57825f826020811061052e5761052d61168f565b5b018190555050505050506105f2565b60025f82602081106105525761055161168f565b5b0154846040516020016105669291906116dc565b6040516020818303038152906040526040516105829190611741565b602060405180830381855afa15801561059d573d5f803e3d5ffd5b5050506040513d601f19601f820116820180604052508101906105c09190611343565b92506002826105cf9190611158565b91508080600101915050610507565b505f6105ed576105ec611757565b5b505050505b50505050505050565b60606106086020546107dd565b905090565b5f805f60205490505f5b6020811015610757576001808316036106b45760025f826020811061063f5761063e61168f565b5b0154846040516020016106539291906116dc565b60405160208183030381529060405260405161066f9190611741565b602060405180830381855afa15801561068a573d5f803e3d5ffd5b5050506040513d601f19601f820116820180604052508101906106ad9190611343565b925061073b565b600283602183602081106106cb576106ca61168f565b5b01546040516020016106de9291906116dc565b6040516020818303038152906040526040516106fa9190611741565b602060405180830381855afa158015610715573d5f803e3d5ffd5b5050506040513d601f19601f820116820180604052508101906107389190611343565b92505b6002826107489190611158565b91508080600101915050610617565b506002826107666020546107dd565b5f60401b60405160200161077c939291906117cf565b6040516020818303038152906040526040516107989190611741565b602060405180830381855afa1580156107b3573d5f803e3d5ffd5b5050506040513d601f19601f820116820180604052508101906107d69190611343565b9250505090565b6060600867ffffffffffffffff8111156107fa576107f9611807565b5b6040519080825280601f01601f19166020018201604052801561082c5781602001600182028036833780820191505090505b5090505f8260c01b90508060076008811061084a5761084961168f565b5b1a60f81b825f815181106108615761086061168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a905350806006600881106108a3576108a261168f565b5b1a60f81b826001815181106108bb576108ba61168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a905350806005600881106108fd576108fc61168f565b5b1a60f81b826002815181106109155761091461168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a905350806004600881106109575761095661168f565b5b1a60f81b8260038151811061096f5761096e61168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a905350806003600881106109b1576109b061168f565b5b1a60f81b826004815181106109c9576109c861168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a90535080600260088110610a0b57610a0a61168f565b5b1a60f81b82600581518110610a2357610a2261168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a90535080600160088110610a6557610a6461168f565b5b1a60f81b82600681518110610a7d57610a7c61168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a905350805f60088110610abe57610abd61168f565b5b1a60f81b82600781518110610ad657610ad561168f565b5b60200101907effffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff191690815f1a90535050919050565b5f80fd5b5f80fd5b5f7fffffffff0000000000000000000000000000000000000000000000000000000082169050919050565b610b4681610b12565b8114610b50575f80fd5b50565b5f81359050610b6181610b3d565b92915050565b5f60208284031215610b7c57610b7b610b0a565b5b5f610b8984828501610b53565b91505092915050565b5f8115159050919050565b610ba681610b92565b82525050565b5f602082019050610bbf5f830184610b9d565b92915050565b5f80fd5b5f80fd5b5f80fd5b5f8083601f840112610be657610be5610bc5565b5b8235905067ffffffffffffffff811115610c0357610c02610bc9565b5b602083019150836001820283011115610c1f57610c1e610bcd565b5b9250929050565b5f819050919050565b610c3881610c26565b8114610c42575f80fd5b50565b5f81359050610c5381610c2f565b92915050565b5f805f805f805f6080888a031215610c7457610c73610b0a565b5b5f88013567ffffffffffffffff811115610c9157610c90610b0e565b5b610c9d8a828b01610bd1565b9750975050602088013567ffffffffffffffff811115610cc057610cbf610b0e565b5b610ccc8a828b01610bd1565b9550955050604088013567ffffffffffffffff811115610cef57610cee610b0e565b5b610cfb8a828b01610bd1565b93509350506060610d0e8a828b01610c45565b91505092959891949750929550565b5f81519050919050565b5f82825260208201905092915050565b5f5b83811015610d54578082015181840152602081019050610d39565b5f8484015250505050565b5f601f19601f8301169050919050565b5f610d7982610d1d565b610d838185610d27565b9350610d93818560208601610d37565b610d9c81610d5f565b840191505092915050565b5f6020820190508181035f830152610dbf8184610d6f565b905092915050565b610dd081610c26565b82525050565b5f602082019050610de95f830184610dc7565b92915050565b5f82825260208201905092915050565b7f4465706f736974436f6e74726163743a20696e76616c6964207075626b6579205f8201527f6c656e6774680000000000000000000000000000000000000000000000000000602082015250565b5f610e59602683610def565b9150610e6482610dff565b604082019050919050565b5f6020820190508181035f830152610e8681610e4d565b9050919050565b7f4465706f736974436f6e74726163743a20696e76616c696420776974686472615f8201527f77616c5f63726564656e7469616c73206c656e67746800000000000000000000602082015250565b5f610ee7603683610def565b9150610ef282610e8d565b604082019050919050565b5f6020820190508181035f830152610f1481610edb565b9050919050565b7f4465706f736974436f6e74726163743a20696e76616c6964207369676e6174755f8201527f7265206c656e6774680000000000000000000000000000000000000000000000602082015250565b5f610f75602983610def565b9150610f8082610f1b565b604082019050919050565b5f6020820190508181035f830152610fa281610f69565b9050919050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c756520745f8201527f6f6f206c6f770000000000000000000000000000000000000000000000000000602082015250565b5f611003602683610def565b915061100e82610fa9565b604082019050919050565b5f6020820190508181035f83015261103081610ff7565b9050919050565b5f819050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601260045260245ffd5b5f61107782611037565b915061108283611037565b92508261109257611091611040565b5b828206905092915050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c7565206e5f8201527f6f74206d756c7469706c65206f66206777656900000000000000000000000000602082015250565b5f6110f7603383610def565b91506111028261109d565b604082019050919050565b5f6020820190508181035f830152611124816110eb565b9050919050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52601160045260245ffd5b5f61116282611037565b915061116d83611037565b92508261117d5761117c611040565b5b828204905092915050565b7f4465706f736974436f6e74726163743a206465706f7369742076616c756520745f8201527f6f6f206869676800000000000000000000000000000000000000000000000000602082015250565b5f6111e2602783610def565b91506111ed82611188565b604082019050919050565b5f6020820190508181035f83015261120f816111d6565b9050919050565b828183375f83830152505050565b5f61122f8385610d27565b935061123c838584611216565b61124583610d5f565b840190509392505050565b5f60a0820190508181035f830152611269818a8c611224565b9050818103602083015261127e81888a611224565b905081810360408301526112928187610d6f565b905081810360608301526112a7818587611224565b905081810360808301526112bb8184610d6f565b90509998505050505050505050565b5f6080820190508181035f8301526112e381898b611224565b905081810360208301526112f8818789611224565b9050818103604083015261130c8186610d6f565b90508181036060830152611321818486611224565b905098975050505050505050565b5f8151905061133d81610c2f565b92915050565b5f6020828403121561135857611357610b0a565b5b5f6113658482850161132f565b91505092915050565b7f4465706f736974436f6e74726163743a207265636f6e737472756374656420445f8201527f65706f7369744461746120646f6573206e6f74206d6174636820737570706c6960208201527f6564206465706f7369745f646174615f726f6f74000000000000000000000000604082015250565b5f6113ee605483610def565b91506113f98261136e565b606082019050919050565b5f6020820190508181035f83015261141b816113e2565b9050919050565b5f8160011c9050919050565b5f808291508390505b6001851115611477578086048111156114535761145261112b565b5b60018516156114625780820291505b808102905061147085611422565b9450611437565b94509492505050565b5f8261148f576001905061154a565b8161149c575f905061154a565b81600181146114b257600281146114bc576114eb565b600191505061154a565b60ff8411156114ce576114cd61112b565b5b8360020a9150848211156114e5576114e461112b565b5b5061154a565b5060208310610133831016604e8410600b84101617156115205782820a90508381111561151b5761151a61112b565b5b61154a565b61152d848484600161142e565b925090508184048111156115445761154361112b565b5b81810290505b9392505050565b5f61155b82611037565b915061156683611037565b92506115937fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff8484611480565b905092915050565b5f6115a582611037565b91506115b083611037565b92508282039050818111156115c8576115c761112b565b5b92915050565b7f4465706f736974436f6e74726163743a206d65726b6c6520747265652066756c5f8201527f6c00000000000000000000000000000000000000000000000000000000000000602082015250565b5f611628602183610def565b9150611633826115ce565b604082019050919050565b5f6020820190508181035f8301526116558161161c565b9050919050565b5f61166682611037565b915061167183611037565b92508282019050808211156116895761168861112b565b5b92915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52603260045260245ffd5b5f819050919050565b6116d66116d182610c26565b6116bc565b82525050565b5f6116e782856116c5565b6020820191506116f782846116c5565b6020820191508190509392505050565b5f81905092915050565b5f61171b82610d1d565b6117258185611707565b9350611735818560208601610d37565b80840191505092915050565b5f61174c8284611711565b915081905092915050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52600160045260245ffd5b5f7fffffffffffffffffffffffffffffffffffffffffffffffff000000000000000082169050919050565b5f819050919050565b6117c96117c482611784565b6117af565b82525050565b5f6117da82866116c5565b6020820191506117ea8285611711565b91506117f682846117b8565b601882019150819050949350505050565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffdfea2646970667358221220d50b8bcc63f95cdb172aa13e9a5ec51dc2f1ab189547eb65ddc4d2f80b175dec64736f6c637828302e382e32332d646576656c6f702e323032332e31312e382b636f6d6d69742e37393163303532310059"

// DefaultDepositContractStorage represents the empty deposit trie used by the deposit contract.
// For details see https://github.com/protolambda/merge-genesis-tools
var DefaultDepositContractStorage = map[string]string{
	"0x0000000000000000000000000000000000000000000000000000000000000022": "0xf5a5fd42d16a20302798ef6ed309979b43003d2320d9f0e8ea9831a92759fb4b",
	"0x0000000000000000000000000000000000000000000000000000000000000023": "0xdb56114e00fdd4c1f85c892bf35ac9a89289aaecb1ebd0a96cde606a748b5d71",
	"0x0000000000000000000000000000000000000000000000000000000000000024": "0xc78009fdf07fc56a11f122370658a353aaa542ed63e44c4bc15ff4cd105ab33c",
	"0x0000000000000000000000000000000000000000000000000000000000000025": "0x536d98837f2dd165a55d5eeae91485954472d56f246df256bf3cae19352a123c",
	"0x0000000000000000000000000000000000000000000000000000000000000026": "0x9efde052aa15429fae05bad4d0b1d7c64da64d03d7a1854a588c2cb8430c0d30",
	"0x0000000000000000000000000000000000000000000000000000000000000027": "0xd88ddfeed400a8755596b21942c1497e114c302e6118290f91e6772976041fa1",
	"0x0000000000000000000000000000000000000000000000000000000000000028": "0x87eb0ddba57e35f6d286673802a4af5975e22506c7cf4c64bb6be5ee11527f2c",
	"0x0000000000000000000000000000000000000000000000000000000000000029": "0x26846476fd5fc54a5d43385167c95144f2643f533cc85bb9d16b782f8d7db193",
	"0x000000000000000000000000000000000000000000000000000000000000002a": "0x506d86582d252405b840018792cad2bf1259f1ef5aa5f887e13cb2f0094f51e1",
	"0x000000000000000000000000000000000000000000000000000000000000002b": "0xffff0ad7e659772f9534c195c815efc4014ef1e1daed4404c06385d11192e92b",
	"0x000000000000000000000000000000000000000000000000000000000000002c": "0x6cf04127db05441cd833107a52be852868890e4317e6a02ab47683aa75964220",
	"0x000000000000000000000000000000000000000000000000000000000000002d": "0xb7d05f875f140027ef5118a2247bbb84ce8f2f0f1123623085daf7960c329f5f",
	"0x000000000000000000000000000000000000000000000000000000000000002e": "0xdf6af5f5bbdb6be9ef8aa618e4bf8073960867171e29676f8b284dea6a08a85e",
	"0x000000000000000000000000000000000000000000000000000000000000002f": "0xb58d900f5e182e3c50ef74969ea16c7726c549757cc23523c369587da7293784",
	"0x0000000000000000000000000000000000000000000000000000000000000030": "0xd49a7502ffcfb0340b1d7885688500ca308161a7f96b62df9d083b71fcc8f2bb",
	"0x0000000000000000000000000000000000000000000000000000000000000031": "0x8fe6b1689256c0d385f42f5bbe2027a22c1996e110ba97c171d3e5948de92beb",
	"0x0000000000000000000000000000000000000000000000000000000000000032": "0x8d0d63c39ebade8509e0ae3c9c3876fb5fa112be18f905ecacfecb92057603ab",
	"0x0000000000000000000000000000000000000000000000000000000000000033": "0x95eec8b2e541cad4e91de38385f2e046619f54496c2382cb6cacd5b98c26f5a4",
	"0x0000000000000000000000000000000000000000000000000000000000000034": "0xf893e908917775b62bff23294dbbe3a1cd8e6cc1c35b4801887b646a6f81f17f",
	"0x0000000000000000000000000000000000000000000000000000000000000035": "0xcddba7b592e3133393c16194fac7431abf2f5485ed711db282183c819e08ebaa",
	"0x0000000000000000000000000000000000000000000000000000000000000036": "0x8a8d7fe3af8caa085a7639a832001457dfb9128a8061142ad0335629ff23ff9c",
	"0x0000000000000000000000000000000000000000000000000000000000000037": "0xfeb3c337d7a51a6fbf00b9e34c52e1c9195c969bd4e7a0bfd51d5c5bed9c1167",
	"0x0000000000000000000000000000000000000000000000000000000000000038": "0xe71f0aa83cc32edfbefa9f4d3e0174ca85182eec9f3a09f6a6c0df6377a510d7",
	"0x0000000000000000000000000000000000000000000000000000000000000039": "0x31206fa80a50bb6abe29085058f16212212a60eec8f049fecb92d8c8e0a84bc0",
	"0x000000000000000000000000000000000000000000000000000000000000003a": "0x21352bfecbeddde993839f614c3dac0a3ee37543f9b412b16199dc158e23b544",
	"0x000000000000000000000000000000000000000000000000000000000000003b": "0x619e312724bb6d7c3153ed9de791d764a366b389af13c58bf8a8d90481a46765",
	"0x000000000000000000000000000000000000000000000000000000000000003c": "0x7cdd2986268250628d0c10e385c58c6191e6fbe05191bcc04f133f2cea72c1c4",
	"0x000000000000000000000000000000000000000000000000000000000000003d": "0x848930bd7ba8cac54661072113fb278869e07bb8587f91392933374d017bcbe1",
	"0x000000000000000000000000000000000000000000000000000000000000003e": "0x8869ff2c22b28cc10510d9853292803328be4fb0e80495e8bb8d271f5b889636",
	"0x000000000000000000000000000000000000000000000000000000000000003f": "0xb5fe28e79f1b850f8658246ce9b6a1e7b49fc06db7143e8fe0b4f2b0c5523a5c",
	"0x0000000000000000000000000000000000000000000000000000000000000040": "0x985e929f70af28d0bdd1a90a808f977f597c7c778c489e98d3bd8910d31ac0f7",
}

var bigz = big.NewInt(0)
var minerBalance = big.NewInt(0)

// DefaultCliqueSigner is the testnet miner (clique signer) address encoded in the special way EIP-225 requires.
// EIP-225 assigns a special meaning to the `extra-data` field in the block header for clique chains.
// In a clique chain, this field contains one secp256k1 "miner" signature. This allows other nodes to
// verify that the block was signed by an authorized signer, in place of the typical PoW verification.
// Clique overloads the meaning of the `miner` and `nonce` fields to implement a voting protocol, whereby additional
// signatures can be added to the list (for details see `Repurposing header fields for signing and voting` in EIP-225).
// https://eips.ethereum.org/EIPS/eip-225
// The following value is for the key used by the e2e test "miner" node.
const DefaultCliqueSigner = "0x0000000000000000000000000000000000000000000000000000000000000000878705ba3f8bc32fcf7f4caa1a35e72af65cf7660000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000"

// GzondShanghaiTime calculates the absolute time of the shanghai (aka capella) fork block
// by adding the relative time of the capella the fork epoch to the given genesis timestamp.
func GzondShanghaiTime(genesisTime uint64) *uint64 {
	var shanghaiTime *uint64

	startSlot, err := slots.EpochStart(0)
	if err == nil {
		startTime := slots.StartTime(genesisTime, startSlot)
		newTime := uint64(startTime.Unix())
		shanghaiTime = &newTime
	}

	return shanghaiTime
}

// GzondTestnetGenesis creates a genesis.json for zond1 clients with a set of defaults suitable for ephemeral testnets,
// like in an e2e test. The parameters are minimal but the full value is returned unmarshaled so that it can be
// customized as desired.
func GzondTestnetGenesis(genesisTime uint64, cfg *clparams.BeaconChainConfig) *core.Genesis {
	shanghaiTime := GzondShanghaiTime(genesisTime)
	cc := &params.ChainConfig{
		ChainID:                       big.NewInt(defaultTestChainId),
		HomesteadBlock:                bigz,
		DAOForkBlock:                  bigz,
		EIP150Block:                   bigz,
		EIP155Block:                   bigz,
		EIP158Block:                   bigz,
		ByzantiumBlock:                bigz,
		ConstantinopleBlock:           bigz,
		PetersburgBlock:               bigz,
		IstanbulBlock:                 bigz,
		MuirGlacierBlock:              bigz,
		BerlinBlock:                   bigz,
		LondonBlock:                   bigz,
		ArrowGlacierBlock:             bigz,
		GrayGlacierBlock:              bigz,
		MergeNetsplitBlock:            bigz,
		TerminalTotalDifficulty:       big.NewInt(0),
		TerminalTotalDifficultyPassed: true,
		Clique: &params.CliqueConfig{
			Period: cfg.SecondsPerZOND1Block,
			Epoch:  20000,
		},
		ShanghaiTime: shanghaiTime,
	}
	da := defaultDepositContractAllocation(cfg.DepositContractAddress)
	ma := minerAllocation()
	extra, err := hexutil.Decode(DefaultCliqueSigner)
	if err != nil {
		panic(fmt.Sprintf("unable to decode DefaultCliqueSigner, with error %v", err.Error()))
	}
	return &core.Genesis{
		Config:     cc,
		Nonce:      0, // overridden for authorized signer votes in clique, so we should leave it empty?
		Timestamp:  genesisTime,
		ExtraData:  extra,
		GasLimit:   math.MaxUint64 >> 1, // shift 1 back from the max, just in case
		Difficulty: common.HexToHash(defaultDifficulty).Big(),
		Mixhash:    common.HexToHash(defaultMixhash),
		Coinbase:   common.HexToAddress(defaultCoinbase),
		Alloc: core.GenesisAlloc{
			da.Address: da.Account,
			ma.Address: ma.Account,
		},
		ParentHash: common.HexToHash(defaultParenthash),
	}
}

type depositAllocation struct {
	Address common.Address
	Account core.GenesisAccount
}

func minerAllocation() depositAllocation {
	return depositAllocation{
		Address: common.HexToAddress(defaultMinerAddress),
		Account: core.GenesisAccount{
			Balance: minerBalance,
		},
	}
}

func defaultDepositContractAllocation(contractAddress string) depositAllocation {
	s := make(map[common.Hash]common.Hash)
	for k, v := range DefaultDepositContractStorage {
		s[common.HexToHash(k)] = common.HexToHash(v)
	}
	codeBytes, err := hexutil.Decode(DepositContractCode)
	if err != nil {
		panic(err)
	}
	return depositAllocation{
		Address: common.HexToAddress(contractAddress),
		Account: core.GenesisAccount{
			Code:    codeBytes,
			Storage: s,
			Balance: bigz,
			Nonce:   deterministicNonce(0),
		},
	}
}

func deterministicNonce(i uint64) uint64 {
	return math.MaxUint64/2 + i
}

func init() {
	err := minerBalance.UnmarshalText([]byte(defaultMinerBalance))
	if err != nil {
		panic(err)
	}
}
